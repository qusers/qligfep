# ligFEP  

This folder contains a step by step tutorial to setup and
analyze ligFEP calculations, as reported in Jespers et al. 
(REF_to_submitted).  

The workflow consists of four main steps:  

- 1 Generate ligand parameters, based on 3D atom coordinates  
- 2 Prepare the protein to run under spherical boundary conditions  
- 3 Generate all the FEP related input files  
- 4 Analyse the results  

The folders in $setupFEP/tutorials are ordered such that it
follows the scheme presented above. A step by step how-to is given
below.  

# 1.ligprep  
Ths folder contains pregenerated 3D-coordinates of the ligand.
Note that these 3D coordinates are not generated by setupFEP, and
you are responsible to get reliable coordinates. It is important
to keep in mind that FEP handles well small changes in the system,
but if the phase space is not sufficiently overlapping the results
become increasingly unreliable. The ligands in this folder are 
all overlaying a similar core region, and small subsitituents on
are investigated.  

For AMBER parameters, please refer to qtools:  

https://zenodo.org/badge/latestdoi/80016679  

Since we have quite a few ligands (n = 16), we will generate the 
files using a script from the script folder, e.g. run:  

    python $setupFEP/scripts/generate_opls.py

This will write out the .lib, .prm and .pdb files needed for 
stage 3. The .log files are generated by ffld_server.  

-- Note --  
To succesfully run this script, a working version of Maestro is
needed, since the OPLS parameters are derived from ffld_server
output. See the setup section in $setupFEP/README.md  

-- Note --  
In order to succesfully run generate_charmm.py:  
- Have cgenff installed and properly referenced in the script  
- Have a running version of openbabel  
- make sure that you have .mol2 files with partial charges added  

-- Note --  
Due to an implementation error in **Q**, 4 letter atom names are not
properly written out. In the case of particularly halogen atoms
you would have to double check and adjust the .pdb file, e.g.
in the case of 17.pdb in this tutorial, change:  

HETATM   25  Br25 LIG   900       3.933  25.020   9.894  

to:  

HETATM   25  Br25LIG   900       3.933  25.020   9.894  

# 2.protprep  
The second step is needed to prepare a protein for simulations
under spherical boundary conditions (SBC). Note that this script
does not attempt to assign protonation states, so one needs to run
a preparation step first (e.g.  Maestro's Protein Preparation 
Wizard). Alternatively, protonation states can be assigned manually 
by using the explicit names as provided in $setupFEP/FF/*.lib files.

The center of the sphere can be based on a residue in the protein, 
or as in this case by explicitly providing the center of geometry 
(COG) coordinates from a ligand. E.g. to get those used in this
example run:

    python $setupFEP/scripts/COG.py ../1.ligprep/17.pdb

Which returns the coordinates 0.535:26.772:8.819, which can be 
directly put in protprep.py:

    python $setupFEP/protprep.py -p 1h1s_PrepWiz.pdb -r 22 -c 0.535:26.772:8.819 -w -P CSB

You can run $setupFEP/protprep.py -h for a full list of options.
The outputs are a .log file, containing some information on the
system and the adaptions made to run it in Q, a protein.pdb and
a water.pdb file. The latter two are needed in the next stage.  

-- NOTE --  
The use of molprobity output is currently under construction!  

# 3.setupFEP  
In the next stage we will prepare the input files for the actual
simulations. This stage uses $setupFEP/setupFEP.py, you can use 
the -h flag to get more specifics on all the input variables. 
This folder includes a useful top level script, generate.py, that
takes a .txt file as input that specifies the ligand pairs that 
will be used in this simulation. You can simply run:  

    python setup.py

And this should result in a 1.protein and 2.water folder, containing
the two systems necessary to perform the calculation. Simply go into
the folder and run  

    ./FEP_submit.sh

This will either submit your jobs to a slurm queue (see the setup
section in $setupFEP/READE.md for a more detailed description).
Alternatively the jobs can be run on your local machine.  

A typical procedure is to put the two systems in a top layer folder
to easily track running calculations (e.g. 1.TESTRUN) in the case
of this example. Of course, these toplayer scripts can be easily
adjusted for any other use (e.g. to calculate solvation free
energies, you add a water and vacuum leg, instead of protein water.  

# 4.analyzeFEP  
The last step includes running the analyze_allFEP.py script, also 
present in the 3.setupFEP folder. In the particular case of this
example, the analysis will be conduced on the 1.TESTRUN folder.
The output is a results.txt file containing the DDG values obtained
for every ligand pair. Exponential averaging (Zwanzig), Overlap
Sampling (OS) and Bennet acceptance ratio (BAR) are used, and the
error is a standard error of the mean over the (finished) replicates.
Alternatively, one can get the free energies per leg by using the
analyze_FEP.py in the main folder. (e.g. you can run:
python $/QligFEP/analyze_FEP.py -h to get an overview of the 
required input).  
