#### Why perform Molecular Dynamics (MD) of a Docking Pose?

Molecular Dynamics (MD) simulations of docking poses serve a crucial purpose in validating and refining initial docking results. When docking is initially performed, it is often done under vacuum conditions, leading to the generation of hypothetical conformations for the protein-ligand complex. However, to ensure the accuracy and reliability of the identified pose, it becomes imperative to explore the system's behavior and dynamics in various solvent environments.


#### Workflow Template

To streamline your workflow, you can copy the template folder provided in the repository. This folder contains all the necessary files and resources for the common use case in QligFEP. Specifically, you will need to place your ligand .pdb files in the 1.ligprep folder and your_protein.pdb in the 2.protprep folder.
For each step, move to the folder named as the step itself. 


# 1. Ligand Preparation
We initiate the process with ligands generated in Maestro, typically provided as PDB files. However, to conduct MD simulations, we require specific parameters that are not available initially. Hence, the ligands undergo a crucial step known as ligand preparation.
For correct usage of QligFEP, dock every ligand in the desired protein, find the best pose for it (i.e. Minimised energy, known interactions etc.) and then align all the ligands with similar core region. 
We won't go in detail on how to get to this.

The folder contains pre-generated 3D-coordinates of the ligands, which are not generated by setupFEP. Therefore, it is our responsibility to ensure that these coordinates are reliable. It is essential to bear in mind that FEP handles small changes in the system effectively, but reliable results are obtained only when the phase space sufficiently overlaps. The ligands in this folder share a similar core region, with variations in small substituents being investigated. For AMBER parameters, please refer to qtools.


### 1.1 Generate the files using a script from the script folder. 
To generate the necessary files using a the script located in the script folder, follow these steps:
1. Move to 1.ligprep folder from the template. If you're not using the template provided, create a folder to store your ligands and call it `1.ligprep`:
* `mkdir 1.ligprep`
2. Navigate to the newly created directory:
* `cd 1.ligprep`
3. Place all your ligand.pdb files inside this folder. If your files are in your local machine and you want to use a Cluster, you can use the following command:
* `scp /path/to/local/file username@cluster_ip:/path/on/cluster/`
4. Finally, run the following command to execute the script:
* `python $qligfep/scripts/generate_opls.py`.
This script will produce the necessary .lib, .prm, and .log files required for the third stage.
The .log files are generated by ffld_server.

Important!
  * Make sure that you've exported qligfep to your .bashrc file (or any other of the common Unix shells) so you can call qligfep from a different folder by using `$qligfep`. 
If you haven't, you can do it following these steps:
    1. `cd` to your home folder
    2. `nano ~/.bashrc`
    3. Add this to the end of the file: `export qligfep=/home/USERNAME/QLIGFEP/qligfep`
    - Keep in mind that `/home/USERNAME/QLIGFEP/qligfep` should be replaced with the PATH to your qligfep folder. If you're not sure of what the path to it is, go to your qligfep folder and run `pwd` to find out. Then, simply replace `/home/USERNAME/QLIGFEP/qligfep` with the returned path from pwd. 
    5. Use `source ~/.bashrc` to apply the changes
  

# 2.Protprep
The second step involves preparing the protein for simulations under spherical boundary conditions (SBC). Please note that this script does not assign protonation states, so a preparation step should be executed beforehand (e.g., using Maestro's Protein Preparation Wizard).
The center of the sphere can be determined based on a residue in the protein or, as in this case, by explicitly providing the center of geometry (COG) coordinates from a ligand. 

### 2.1 Obtain COG coordinates. 
To do so run:
`python "$qligfep/scripts/COG.py" -i ligand_path.pdb`

For example, to obtain the COG coordinates used in this example, run:
`python "$qligfep/scripts/COG.py" -i ../1.ligprep/17.pdb`
This will return the coordinates [0.535:26.772:8.819]
! Make sure to **add -i before the pdb file**. 

### 2.2 Add the COG coordinates directly in protprep.py:
`python "$qligfep/protprep.py" -p path_to_protein.pdb -r RADIUS -c COORDINATES -w -P CLUSTER_NAME --noclean`

_The '--noclean' flag serves a specific purpose by retaining files such as 'qprep.inp' for display. In subsequent stages, particularly during utilization by 'setup.py', the contents of this file become instrumental in gathering data concerning necessary cysteine bond additions. Throughout this process, it's possible to encounter an error marked by 'FileNotFoundError: [Errno 2] No such file or directory: 'top_p.pdb'.' For a more comprehensive understanding of this issue, refer to the 'Common Errors messages' section located at the end of this document._

For this tutorial:

- `python "$qligfep/protprep.py" -p 1h1s_PrepWiz.pdb -r 22 -c [0.535:26.772:8.819] -w -P CSB --noclean`

After this, you should have three new files in 2.protprep: protPREP.log  protein.pdb  water.pdb.

**Note: Prior to executing the above command, ensure that you have navigated to the folder containing the "1h1s_PrepWiz.pdb" file.**
Furthermore, it is essential to bear in mind that the ligands under investigation share a similar core region, with only minor variations in small substituents. During previous phases, these ligands were superimposed, likely using Maestro. As a result, their centers of geometry are nearly identical. Therefore, we need to perform this process **for just one ligand**, saving time and effort.

# 3.setupFEP
In the next stage we will prepare the input files for the actual simulations.

### 3.1 Prepare input files

#### 3.1.1 Pairs.txt
To ensure accurate calculation of ddG, QligFEP requires a well-defined list of paired combinations. Following a recommended protocol, it's advisable to curate pairs that exhibit maximal similarity while progressing from intricate to simpler compositions. The 'pairs.txt' file plays a pivotal role in this process and mandates specific conventions.

Each entry within 'pairs.txt' corresponds to a pair of ligands, and it should contain the ligand's identifier, matching the name in the corresponding '.pdb' file within the '1.ligprep' folder. The identifier should exclude the '.pdb' extension, with pairs differentiated by a single space. This procedure is to be repeated for every pair of ligands.

For instance, let's consider an illustrative scenario with four distinct ligands, each characterized by a different moiety (R):

Ligand_A (R = 2-F-Benzyl), stored as 'ligand_a.pdb' in the '1.ligprep' folder.
Ligand_B (R = Benzyl), stored as 'ligand_b.pdb' in the '1.ligprep' folder.
Ligand_C (R = Propyl), stored as 'ligand_c.pdb' in the '1.ligprep' folder.
Ligand_D (R = Methyl), stored as 'ligand_d.pdb' in the '1.ligprep' folder.

The corresponding 'pairs.txt' file should be structured as follows:
```
ligand_a ligand_b
ligand_c ligand_d
```

One can also invert the pairs to see if the results are similar as they should be equal in absolute value. So:

```
ligand_a ligand_b
ligand_b ligand_a
ligand_c ligand_d
ligand_d ligand_c
```
#### 3.1.2 QligFEP.py
This stage uses `$qligfep/QligFEP.py`. You can use the -h flag to get more specifics on all the input variables. This folder includes a useful top level script, `generate.py`, that takes the pairs.txt file as input that specifies the ligand pairs that will be used in this simulation.

We then run QligFEP.py by running setup.py:
- `python setup.py`

_Note: In this forked version, setup.py is capable of moving the files necessary to use QligFEP.py. If you're using a different version of setup.py, you will have to manually move all the ligands.pbd from `1.ligprep`, the protein.pdb and water.pdb files from `2.protprep`_ in order to do this step. 

This should result in a 1.protein and 2.water folder, containing folders for each pair of ligands described in the `pairs.txt` file. A message will be printed specifying the cystein bonds added. Make sure they are correct (i.e. no atoms duplicated). A `qprep ended normally`message should be printed for each pair correctly added to the folder.

To perform the calculation. Simply go into the folder (1.PROTEIN OR 2.WATER), then go into the pair folder whose job you want to submit and run
`./FEP_submit.sh`

This script will either submit your jobs to a slurm queue (see the setup section in $setupFEP/README.md for a more detailed description). Alternatively the jobs can be run on your local machine.
A typical procedure is to put the two systems in a top layer folder to easily track running calculations (e.g. 1.TESTRUN) in the case of this example. Of course, these toplayer scripts can be easily adjusted for any other use (e.g. to calculate solvation free energies, you add a water and vacuum leg, instead of protein water.

If you want to submit all the jobs at once without having to go into each pair folder, you can copy `submit_FEP.py` to your `1.protein` or `2.water` folder and then run it. This python script will find all the folders starting as 'FEP_' (basically, all the folders named after the pairs.txt file) and submit their job. 

_Note: Only in this forked version submit_FEP.py exists. If your using the original repository you will have to submit all the jobs manually or copy the code for submit_FEP.py from [here](https://github.com/afloresep/qligfep/blob/master/submit_FEP.py) and add it to your workspace._

# 4. Analyze dG in protein and water. 
Run the analyze_FEP.py script with the appropriate parameters:
`python analyze_FEP.py -F path_to_FEP_pair1-pair2_folder -C CLUSTER`
In this tutorial this will be:
`python analyze_FEP.py -F tutorials/1.QligFEP_CDK2/3.setupFEP/1.protein/FEP_22-17 -C CSB` 


_Note: You should run this command for each FEP_ligand1-ligand2 folder specified in the pairs.txt file, located in both the `1.protein` and `2.water` folders._

This will give us the dG calculations for the pair 22-17 in 1.protein. You will have as many FEP_ligand1-ligand2 folders as pairs indicated in the `pairs.txt` file. Thus, you will need to run `analyze_FEP.py` in all of them, for both `1.protein` and `2.water` folders.
Nonetheless, if you want to call analzye_FEP.py for all folders located in 1.protein or 2.water (those named after the pair.txt file: i.e. FEP_17-22) you may use `call_analyzeFEP.py` located in qligfep folder as:
`python call_analyze_FEP.py path_to_1.protein_folder -C CSB` and then `python call_analyze_FEP.py path_to_2.water_folder -C CSB`. 

_Note: Again, these are python scripts specific to this repository and may not be available in the original repository where you will have to do it manually._

**To change the number of runs**, modify the FEP_submit.sh file located in the path of each pair: 
/home/USER/QLIGFEP/qligfep/tutorials/1.QligFEP_CDK2/3.setupFEP/1.protein/FEP_17-22

It is necessary to collect dG values for both ligand pairs in water and protein since a complete thermodynamic cycle is needed to calculate ddG.
(for further understanding of the thermodynamic cycle: https://pubs.acs.org/doi/pdf/10.1021/acs.jcim.7b00564)

## Following steps:
### Calculating ddG: 
First, we have to ask the question: 
#### _Why do we want to calculate ddG in the first place?_
Before diving into the calculation of ddG, let's understand its purpose. The primary objective is to determine the difference in binding free energy (ddGbind) between two ligands or multiple pairs of ligands with slight variations. This allows us to assess their relative binding affinities to the receptor. ddGbind represents the energy required for one ligand (B) to bind the receptor compared to another ligand (A).


#### _How can we calculate ddG?_
To calculate ddG, we rely on Free Energy Perturbation (FEP) simulations conducted in both the protein and water environments. The difference in free energy between these two transformations ($$\Delta G_{R} - \Delta G_{w}$$) will be theoretically equivalent to the differnece in binding free energy between the two ligands $$\Delta\Delta G_{\text{bind (B-A)}} = \Delta G_{\text{bind, B}} - \Delta G_{\text{bind, A}}$$). For a more detailed explanation of this concept you can refer to [this article](https://link.springer.com/protocol/10.1007/978-1-0716-1209-5_12)

In summary, we need to take the dG results obtained from step 4 and calculate the difference between the two states (protein and water) for all ligand pairs.




_For ease of calculation, we can utilize an Excel file. An Excel template is available for download from [here](https://github.com/afloresep/qligfep/blob/master/ddG_template.xlsx)_

In summary, with the help of the template we will calculate: 
1. Calculate the average dG for each ligand pair in the protein environment:
   $$\bar{dG_{\text{protein}}} = \frac{\sum_{i=1}^{n} dG_{\text{}, i}}{n_{\text{}}}$$
2. Calculate the average dG for each ligand pair in the water environment:
 $$\bar{dG_{\text{water}}} = \frac{\sum_{i=1}^{n} dG_{\text{}, i}}{n_{\text{}}}$$
3. Calculate the ddG for each pair (ddG(A->B) = AVG(dGprotein) - AVG(dGwater)):
$$ddG(A \to B) = \bar{dG_{\text{protein}}} - \bar{dG_{\text{water}}}$$
4. Calculate the Standard Error of the Mean (SEM) for the protein and water environments:
$$SEM = \frac{\sigma}{\sqrt{n}}$$
5. Calculate the final SEM:
$$SEM_{f} = \sqrt{SEM_{\text{water}}^2 + SEM_{\text{protein}}^2}$$
6. Finally, obtain the ddG value along with the error margin:
$$ddG (A \to B) \pm \sqrt{SEM_{\text{water}}^2 + SEM_{\text{protein}}^2}$$

Typically, you would compare these results with experimental data. To calculate experimental ddG from Ki (constant of inhibition), you can use the following formula:

$$\Delta G^\circ = -RT \ln K$$

### Comparing ddG with experimental data:
So far, we have obtained theoretical values for ddG between various pairs of ligands based on docking poses under optimal conditions. However, this information alone may not suffice since the actual binding mode of the ligands could differ. Hence, it is essential to compare the theoretical ddG with experimental ddG.

$$\Delta G^\circ = -RT \ln K$$
_R_ is the gas constant with a value of 8.314 J 8.314 J K-1mol-1
_T_ is the temperature of the reaction in Kelvin.
_ΔG°_ the standard Gibbs free energy change between two states. 

The predicted ΔG° values from relative binding free energy calculations can be directly compared to Ki values. However, in many cases, only experimental IC50 values are available. Although IC50 and Ki values are sometimes used interchangeably, it's crucial to consider the compound's mechanism of inhibition and the specific assay conditions. The Cheng−Prusoff equation provides a mathematical description of the relationship between Ki and IC50 for competitive inhibitors that bind to the free enzyme:

$$K_i = \frac{IC_{50}}{1 + \frac{[S]}{K_m}}$$

_Ki_ = the inhibitory constant, defined as the equilibrium concentration of an inhibitory ligand when 50% of the receptor sites are occupied if no competing substrate is present.   

_IC50_ = The concentration at which the inhibitory ligand displaces 50% of the substrate.   

_[S]_ = The concentration of the substrate used in the binding assay.  

_Km_ = the affinity constant of the substrate, defined as the equilibrium concentration that results in substrate occupying 50% of the receptor sites in the absence of competitio

If the _[S]_ is small enough (depends on what your data) one can assume then that [S] = 0 so that:
$$K_i = \frac{IC_{50}}{1 + \frac{0}{K_m}}$$
and therefore: 
$$K_i = {IC_{50}}$$

For a more detailed understanding of the topic, refer to [further reading](https://pubs.acs.org/doi/pdf/10.1021/acs.jcim.7b00564).


## Common Error messages:
### - qligfep/protprep.py Error Handling:
`FileNotFoundError: [Errno 2] No such file or directory: 'top_p.pdb'`: 
The most prevalent cause for encountering this error is an erroneous configuration within the 'qprep.inp' file. In certain instances, the 'qprep.inp' file contains two or more cysteine bonds utilizing the same atom, which disrupts the process of generating the topology PDB file. To address this, manual intervention is required to remove the conflicting cysteine bond that employs atoms that have been previously used. The following steps outline how to rectify this issue:

#### 1. Manual Correction of qprep.inp
Open your 'qprep.inp' file using a text editor such as vim or nano. Examine the content and locate the lines involving 'addbond' commands, such as
Practical example: 
###
addbond 69:SG 164:SG y
addbond 75:SG 168:SG y
addbond 151:SG 163:SG y
addbond 163:SG 164:SG
###

In the final line, observe that 'addbond' 3 and 'addbond' 4 utilize the same atom '163:SG'. Delete the problematic line (last 'addbond') to resolve the conflict. Save the modified 'qprep.inp' file.

#### 2. Utilize Modified qprep.inp with qprep:
Execute the 'qprep' program from the 'q6/bin' directory, utilizing the newly edited 'qprep.inp' file:
`path_to_q6_folder/q6/bin/qprep < qprep.inp`
Please adapt the command based on the location of your 'q6/bin' directory. For instance, if the directory is located at '/home/user/QLIGFEP/q6/', the command would be:
`/home/user/QLIGFEP/q6/bin/qprep < qprep.inp`

#### 3. Substitute Protein PDB:
Upon completing the previous step, you should find a file named 'complexnotexcluded.pdb' alongside other files. Replace your original protein PDB file ('your_protein.pdb') with this modified PDB file using the 'cp' command
`cp complexnotexcluded.pdb your_protein.pdb`


#### 4. Invoke qprep.py with Updated PDB:
Once the replacement is done, you can rerun the 'qprep.py' script with the newly updated PDB file using the following command:
`python "$qligfep/protprep.py" -p your_protein.pdb -r RADIUS -c COORDINATES -w -P CLUSTER_NAME --noclean`
Ensure to replace placeholders such as 'RADIUS', 'COORDINATES', and 'CLUSTER_NAME' with actual values as needed.










